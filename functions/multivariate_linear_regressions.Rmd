---
title: "multivariate linear regressions"
output: md_document
---

get & prep data
```{r get & prep data}
library(car)
library(hash)
library(MASS)
library(MESS)
library(plyr)
library(ROCR)
data <- read.csv('../data/CPP_data_all.csv', header=TRUE)
smq <- read.csv('../data/SMQ.csv', header=TRUE)
smq$smq_id <- (18 - smq$smq_id) / 6
data <- ddply(data, .(URSI, SM_dx), summarize,
              Turn_Count=sum(Turn_Count),
              Child_Voc_Count=sum(Child_Voc_Count),
              Child_Voc_Duration=sum(Child_Voc_Duration),
              Child_NonVoc_Duration=sum(Child_NonVoc_Duration),
              Average_SignalLevel=mean(Average_SignalLevel),
              Peak_SignalLevel=max(Peak_SignalLevel)
              )
data <- merge(data, smq, by="URSI", all=TRUE)
remove(smq)
# invert SMQ for severity
data$smq_as <- 3 - data$smq_as
data$smq_hf <- 3 - data$smq_hf
data$smq_ss <- 3 - data$smq_ss
data$smq_id <- 3 - data$smq_id
data$SM_dx <- factor(data$SM_dx)
smq_data <- data[complete.cases(data),]
```

multivariate forward linear regression for SMQ
```{r forward regression for SMQ}
smq <- c("smq_as", "smq_hf", "smq_ss", "smq_id")
fsmq_predicted <- vector()
fsmq_actual <- vector()
fsmq_models <- vector()
fsmq_predictors <- hash()
for(k in 1:4){
  for(i in 1:nrow(smq_data)){
    train <- smq_data[-i,]
    test <- smq_data[i,]
    predicted <- vector()
    actual <- vector()
    predictors <- hash()
    model <- step(lm(smq[k]~1, data=train, na.action=na.omit),
             direction='forward', scope=~Child_Voc_Count+Turn_Count+
             Child_Voc_Duration+Child_NonVoc_Duration+Average_SignalLevel+
             Peak_SignalLevel)
    for(j in 1:length(names(model$coefficients))){
      if(has.key(names(model$coefficients)[[j]], predictors)){
        .set(predictors, names(model$coefficients)[[j]],
             as.numeric(predictors[[names(model$coefficients)[[j]]]])+ 1)
      }else{
        .set(predictors, names(model$coefficients)[[j]], 1)
      }
    predicted <- c(predicted, predict(model, test))
    actual <- c(actual, test$smq[k])
    }
    remove(j)
    remove(train)
    remove(test)
  }
  fsmq_predicted <- c(fsmq_predicted, predicted)
  fsmq_actual <- c(fsmq_actual, actual)
  fsmq_models <- c(fsmq_models, model)
}
print(fsmq_predictors)
remove(i)
```

```{r plot for forward regression predicting SMQ}
par(pty="s")
plot(cumsum(fsmq_predicted)/sum(fsmq_predicted), cumsum(fsmq_actual)/sum(fsmq_actual), type='p',
     xlab="Predicted SMQ symptom severity",ylab="Reported SMQ symptom severity", asp=1)
abline(lm(as.numeric(cumsum(fsmq_actual)/sum(fsmq_actual))~as.numeric(cumsum(fsmq_predicted)/sum(
       fsmq_predicted))))
```

```{r}
plot(smq_as+smq_hf+smq_ss+smq_id ~ Child_Voc_Count, data=smq_data)
abline(lm(smq_as+smq_hf+smq_ss+smq_id ~ Child_Voc_Count, data=smq_data))
```

```{r}
plot(smq_as+smq_hf+smq_ss+smq_id ~ Child_Voc_Duration, data=smq_data)
abline(lm(smq_as+smq_hf+smq_ss+smq_id ~ Child_Voc_Duration, data=smq_data))
```

```{r}
plot(smq_as+smq_hf+smq_ss+smq_id ~ Average_SignalLevel, data=smq_data)
abline(lm(smq_as+smq_hf+smq_ss+smq_id ~ Average_SignalLevel, data=smq_data))
```